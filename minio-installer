#!/bin/bash
#
# MinIO single-node installer using Docker Compose
# Inspired by: install-harbor.sh framework
#

# --- User Defined Variables --- #

DEBUG=${DEBUG:-1}

# MinIO container version/tag
MINIO_VERSION=${MINIO_VERSION:-"latest"}        # e.g. "latest" or a specific release

# Service identity / TLS
MINIO_FQDN=${MINIO_FQDN:-"minio.edge.lab"}

# Bind address for local host (for dual-homed systems, etc.)
BIND_ADDRESS=${BIND_ADDRESS:-"$(hostname -I | awk '{print $1}')"}  # IP to bind and use in SAN

# Certificate subject
COUNTRY=${COUNTRY:-"US"}
STATE=${STATE:-"MA"}
LOCATION=${LOCATION:-"BOSTON"}
ORGANIZATION=${ORGANIZATION:-"SELF"}
DURATION_DAYS=${DURATION_DAYS:-"3650"}

# MinIO admin credentials
MINIO_ROOT_USER=${MINIO_ROOT_USER:-"minioadmin"}
MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-"minioadmin123"}

# Default bucket config
MINIO_DEFAULT_BUCKET=${MINIO_DEFAULT_BUCKET:-"default-bucket"}

# Ports
MINIO_S3_PORT=${MINIO_S3_PORT:-"9000"}
MINIO_CONSOLE_PORT=${MINIO_CONSOLE_PORT:-"9001"}

# Paths
MINIO_BASE_DIR=${MINIO_BASE_DIR:-"/opt/minio"}
MINIO_DATA_DIR=${MINIO_DATA_DIR:-"$MINIO_BASE_DIR/data"}
MINIO_CERT_DIR=${MINIO_CERT_DIR:-"$MINIO_BASE_DIR/certs"}
MINIO_COMPOSE_FILE=${MINIO_COMPOSE_FILE:-"$MINIO_BASE_DIR/docker-compose.yml"}

# Container names
MINIO_CONTAINER_NAME=${MINIO_CONTAINER_NAME:-"minio-server"}

# --- INTERNAL VARIABLES (do not edit) --- #

base_dir=$(pwd)
user_name=${SUDO_USER:-$(whoami)}
mgmt_ip=$(hostname -I | awk '{print $1}')
current_hostname=$(hostname)

# --- Utility Functions --- #

debug_run() {
  if [ "$DEBUG" -eq 1 ]; then
    echo "--- DEBUG: Running '$*' ---"
    "$@"
    local status=$?
    echo "--- DEBUG: Finished '$*' with status $status ---"
    return $status
  else
    "$@" >/dev/null 2>&1
    return $?
  fi
}

check_root_privileges() {
  if [[ $EUID != 0 ]]; then
    echo "This script must be run with sudo or as the root user."
    exit 1
  fi
}

check_docker_installed() {
  if ! command -v docker >/dev/null 2>&1; then
    echo "Error: docker is not installed or not in PATH."
    echo "Please install Docker before running this script."
    exit 1
  fi
}

get_compose_cmd() {
  if docker compose version >/dev/null 2>&1; then
    echo "docker compose"
  elif command -v docker-compose >/dev/null 2>&1; then
    echo "docker-compose"
  else
    echo "Error: docker compose (plugin) or docker-compose (standalone) is required." >&2
    return 1
  fi
}

validate_dns() {
  echo "Validating DNS for '$MINIO_FQDN' against bind address '$BIND_ADDRESS'..."
  local dns_ip
  dns_ip=$(getent ahosts "$MINIO_FQDN" 2>/dev/null | awk '/STREAM/ {print $1; exit}')

  if [[ -z "$dns_ip" ]]; then
    echo "WARNING: DNS lookup for '$MINIO_FQDN' failed. The name may not be resolvable."
    return 0
  fi

  if [[ "$dns_ip" != "$BIND_ADDRESS" ]]; then
    echo "WARNING: DNS for '$MINIO_FQDN' resolves to '$dns_ip' but bind address is '$BIND_ADDRESS'."
    echo "Clients may not be able to reach MinIO using the configured FQDN."
  else
    echo "DNS validation successful: '$MINIO_FQDN' -> '$dns_ip'."
  fi
}

# --- TLS Certificate Generation --- #

generate_certs() {
  echo "Creating self-signed certificate valid for $DURATION_DAYS days..."
  mkdir -p "$MINIO_CERT_DIR"

  # CA key + cert (for completeness, MinIO uses public/private only)
  openssl genrsa -out "$MINIO_CERT_DIR/ca.key" 4096
  openssl req -x509 -new -nodes -sha512 -days "$DURATION_DAYS" \
    -subj "/C=$COUNTRY/ST=$STATE/L=$LOCATION/O=$ORGANIZATION/CN=$MINIO_FQDN" \
    -key "$MINIO_CERT_DIR/ca.key" \
    -out "$MINIO_CERT_DIR/ca.crt"

  # Server key
  openssl genrsa -out "$MINIO_CERT_DIR/private.key" 4096

  # CSR
  openssl req -sha512 -new \
    -subj "/C=$COUNTRY/ST=$STATE/L=$LOCATION/O=$ORGANIZATION/CN=$MINIO_FQDN" \
    -key "$MINIO_CERT_DIR/private.key" \
    -out "$MINIO_CERT_DIR/minio.csr"

  # v3.ext for SANs
  cat >"$MINIO_CERT_DIR/v3.ext" <<EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = $MINIO_FQDN
DNS.2 = $current_hostname
IP.1  = $BIND_ADDRESS
EOF

  # Signed cert -> public.crt (MinIO requires /certs/public.crt and /certs/private.key)
  openssl x509 -req -sha512 -days "$DURATION_DAYS" \
    -extfile "$MINIO_CERT_DIR/v3.ext" \
    -CA "$MINIO_CERT_DIR/ca.crt" \
    -CAkey "$MINIO_CERT_DIR/ca.key" \
    -CAcreateserial \
    -in "$MINIO_CERT_DIR/minio.csr" \
    -out "$MINIO_CERT_DIR/public.crt"

  echo "Certificate generation completed."
}

# --- Docker Compose Configuration --- #

generate_compose_file() {
  echo "Generating docker-compose.yml at $MINIO_COMPOSE_FILE ..."
  mkdir -p "$MINIO_BASE_DIR"

  cat >"$MINIO_COMPOSE_FILE" <<EOF
version: "3.9"

services:
  minio:
    image: minio/minio:${MINIO_VERSION}
    container_name: ${MINIO_CONTAINER_NAME}
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD}"
      MINIO_SERVER_URL: "https://${MINIO_FQDN}:${MINIO_S3_PORT}"
      MINIO_BROWSER_REDIRECT_URL: "https://${MINIO_FQDN}:${MINIO_CONSOLE_PORT}"
    ports:
      - "${BIND_ADDRESS}:${MINIO_S3_PORT}:9000"
      - "${BIND_ADDRESS}:${MINIO_CONSOLE_PORT}:9001"
    volumes:
      - "${MINIO_DATA_DIR}:/data"
      - "${MINIO_CERT_DIR}:/certs"
EOF
}

start_minio_compose() {
  local compose_cmd
  compose_cmd=$(get_compose_cmd) || exit 1

  mkdir -p "$MINIO_DATA_DIR"
  mkdir -p "$MINIO_CERT_DIR"

  if [[ -d "$MINIO_DATA_DIR/.minio.sys" ]]; then
    echo "NOTE: Existing MinIO data directory detected at '$MINIO_DATA_DIR'."
    echo "      Existing credentials/config will be preserved. New MINIO_ROOT_USER/PASSWORD may be ignored."
  fi

  echo "Starting MinIO using Docker Compose..."
  (cd "$MINIO_BASE_DIR" && $compose_cmd up -d)
}

stop_minio_compose() {
  local compose_cmd
  compose_cmd=$(get_compose_cmd) || return 0

  if [[ -f "$MINIO_COMPOSE_FILE" ]]; then
    echo "Stopping MinIO using Docker Compose..."
    (cd "$MINIO_BASE_DIR" && $compose_cmd down || true)
  fi
}

# --- Health Check --- #

wait_for_minio() {
  echo "Waiting for MinIO to become ready (HTTPS)..."
  local retries=60
  local delay=5
  local i=0

  # Health endpoint: /minio/health/ready on S3 port
  local health_url="https://${MINIO_FQDN}:${MINIO_S3_PORT}/minio/health/ready"

  while ((i < retries)); do
    local code
    code=$(curl -k -s -o /dev/null -w "%{http_code}" "$health_url" || echo "000")

    if [[ "$code" == "200" ]]; then
      echo "MinIO reports ready (HTTP $code)."
      return 0
    fi

    i=$((i + 1))
    echo "  Attempt $i/$retries: MinIO not ready yet (HTTP $code), retrying in ${delay}s..."
    sleep "$delay"
  done

  echo "WARNING: MinIO did not become healthy within the expected time. mc operations may fail."
}

# --- MinIO Client (mc) and Bucket Creation --- #

configure_minio_and_bucket() {
  echo "Configuring MinIO with default bucket '$MINIO_DEFAULT_BUCKET'..."
  local s3_url="https://${MINIO_FQDN}:${MINIO_S3_PORT}"

  # Remove any stale mc container
  if docker ps -a --format '{{.Names}}' | grep -q "^minio-mc\$"; then
    docker rm -f minio-mc >/dev/null 2>&1 || true
  fi

  docker run --rm \
    --name minio-mc \
    --entrypoint /bin/sh \
    minio/mc \
    -c "
      set -e

      mc alias set local '$s3_url' '$MINIO_ROOT_USER' '$MINIO_ROOT_PASSWORD' --insecure >/dev/null 2>&1 || \
        mc alias set local '$s3_url' '$MINIO_ROOT_USER' '$MINIO_ROOT_PASSWORD' --api S3v4 --insecure

      if ! mc ls local >/dev/null 2>&1; then
        echo 'ERROR: Failed to connect to MinIO using mc.'
        exit 1
      fi

      if ! mc ls local/$MINIO_DEFAULT_BUCKET >/dev/null 2>&1; then
        mc mb local/$MINIO_DEFAULT_BUCKET --ignore-existing >/dev/null 2>&1 || true
      fi
    "

  echo "Default bucket '${MINIO_DEFAULT_BUCKET}' ensured."
}

# --- Install / Uninstall Routines --- #

install_minio() {
  debug_run check_docker_installed
  debug_run validate_dns
  debug_run generate_certs
  debug_run generate_compose_file
  debug_run start_minio_compose
  debug_run wait_for_minio
  debug_run configure_minio_and_bucket

  local console_url="https://${MINIO_FQDN}:${MINIO_CONSOLE_PORT}"
  local s3_url="https://${MINIO_FQDN}:${MINIO_S3_PORT}/${MINIO_DEFAULT_BUCKET}"

  echo
  echo "# --- MinIO Installation Completed --- #"
  echo "  MinIO Image:           minio/minio:${MINIO_VERSION}"
  echo "  Bind Address:          $BIND_ADDRESS"
  echo "  FQDN:                  $MINIO_FQDN"
  echo "  Data Directory:        $MINIO_DATA_DIR"
  echo "  Certificates Directory:$MINIO_CERT_DIR"
  echo "  Compose File:          $MINIO_COMPOSE_FILE"
  echo
  echo "  Console URL:           $console_url"
  echo "  S3 Endpoint URL:       $s3_url"
  echo
  echo "  Admin User:            $MINIO_ROOT_USER"
  echo "  Admin Password:        $MINIO_ROOT_PASSWORD"
  echo
  echo "  Default Bucket:        $MINIO_DEFAULT_BUCKET"
  echo
}

uninstall_minio() {
  echo "Uninstalling MinIO..."

  stop_minio_compose

  # Remove remaining container if still present
  if docker ps -a --format '{{.Names}}' | grep -q "^${MINIO_CONTAINER_NAME}\$"; then
    echo "Removing MinIO container '$MINIO_CONTAINER_NAME'..."
    docker rm -f "$MINIO_CONTAINER_NAME" >/dev/null 2>&1 || true
  fi

  echo "Removing MinIO directories under '$MINIO_BASE_DIR'..."
  rm -rf "$MINIO_BASE_DIR"

  echo "MinIO uninstallation completed."
}

# --- CLI Help --- #

help() {
  cat <<EOF
########################################################################
###                     MinIO Docker Installer                       ###
########################################################################
Usage: $0 [parameter]

[Parameters]            | [Description]
help                    | Display this help message
install-minio           | Install and configure MinIO (Docker Compose)
uninstall-minio         | Uninstall MinIO and remove data/config
EOF
}

# --- Main CLI Wrapper --- #

while [[ $# -gt 0 ]]; do
  case "$1" in
    help|--help|-h)
      help
      exit 0
      ;;
    install-minio)
      check_root_privileges
      echo "######################################"
      echo "###     MinIO Installation Start   ###"
      echo "######################################"
      install_minio
      exit 0
      ;;
    uninstall-minio)
      check_root_privileges
      echo "########################################"
      echo "###     MinIO Uninstallation Start   ###"
      echo "########################################"
      uninstall_minio
      exit 0
      ;;
    *)
      echo "Invalid option: $1"
      echo
      help
      exit 1
      ;;
  esac
  shift
done

help